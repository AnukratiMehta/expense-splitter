<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title><%= group.name %></title>
</head>
<body>

<h1><%= group.name %></h1>

<h3>Members:</h3>
<ul>
  <% members.forEach(m => { %>
    <li><%= m.username %></li>
  <% }) %>
</ul>

<% if (currentUser.id === group.ownerId) { %>
  <h3>Add Member</h3>
  <form action="/groups/<%= group.id %>/add-member" method="POST">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">

    <label>Username:</label>
    <input type="text" name="username" required>

    <button type="submit">Add</button>
  </form>
<% } %>

<hr>

<h3>Add Expense</h3>

<form action="/groups/<%= group.id %>/expenses/add" method="POST">
  <input type="hidden" name="_csrf" value="<%= csrfToken %>">

  <label>Description:</label>
  <input type="text" name="description" required>

  <br><br>

  <label>Total Amount (€):</label>
  <input type="number" step="0.01" name="amount" required>

  <h4>Split Between Members</h4>

  <% members.forEach(m => { %>
    <div>
      <label><%= m.username %>:</label>
      <input 
        type="number"
        step="0.01"
        name="splits[<%= m.id %>]"
        required
        value="0"
      >
    </div>
  <% }) %>

  <br>
  <button type="submit">Add Expense</button>
</form>

<hr>

<h3>Expenses</h3>

<ul>
  <% expenses.forEach(e => { %>
    <li>
      <strong><%= e.description %></strong> — €<%= e.amount %>
      (paid by <%= e.paidByName %>)

      <!-- Edit -->
      <a href="/groups/<%= group.id %>/expenses/<%= e.id %>/edit">Edit</a>

      <!-- Delete -->
      <form
        action="/groups/<%= group.id %>/expenses/<%= e.id %>/delete"
        method="POST"
        style="display:inline;"
      >
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <button type="submit">Delete</button>
      </form>
    </li>
  <% }) %>
</ul>

<hr>

<h3>Balances</h3>

<ul>
  <% members.forEach(m => { 
       const bal = balances[m.id];
  %>
    <li>
      <strong><%= m.username %></strong>:
      <% if (bal > 0) { %>
        should receive €<%= bal.toFixed(2) %>
      <% } else if (bal < 0) { %>
        owes €<%= Math.abs(bal).toFixed(2) %>
      <% } else { %>
        is settled up
      <% } %>
    </li>
  <% }) %>
</ul>

<hr>

<h3>Suggested Settlements</h3>

<% if (settlements.length === 0) { %>
  <p>Everyone is settled up.</p>
<% } else { %>
  <ul>
    <% settlements.forEach(s => { %>
      <li>
        <strong><%= userMap[s.fromUserId] %></strong>
        should pay
        <strong><%= userMap[s.toUserId] %></strong>
        €<%= s.amount.toFixed(2) %>
      </li>
    <% }) %>
  </ul>
<% } %>

</body>
</html>
