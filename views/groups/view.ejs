<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title><%= group.name %></title>
  <link rel="stylesheet" href="/css/styles.css">
</head>

<body>

<!-- NAVBAR -->
<div class="navbar">
  <div>
    <a href="/">Home</a>
    <a href="/groups">Groups</a>
  </div>

  <div>
    <span>Logged in as <strong><%= currentUser.username %></strong></span>
    <form action="/logout" method="POST" style="display:inline;">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <button class="small-btn" type="submit">Logout</button>
    </form>
  </div>
</div>

<!-- MAIN CONTAINER -->
<div class="container">
  <% if (success) { %>
  <div class="notice" style="background:#d8f8d8; border:1px solid #a6e8a6; margin-bottom:1rem;">
    <strong><%= success %></strong>
  </div>
<% } %>

<% if (error) { %>
  <div class="notice" style="background:#ffd3d3; border:1px solid #ff9e9e; margin-bottom:1rem;">
    <strong><%= error %></strong>
  </div>
<% } %>


  <!-- Group Header -->
  <h1><%= group.name %></h1>

  <h3>Members</h3>
  <ul>
    <% members.forEach(m => { %>
      <li><%= m.username %></li>
    <% }) %>
  </ul>

  <% if (currentUser.id === group.ownerId) { %>
    <h3>Add Member</h3>

    <form action="/groups/<%= group.id %>/add-member" method="POST">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">

      <label>Username</label>
      <input type="text" name="username" placeholder="Enter username..." required>

      <button type="submit">Add Member</button>
    </form>
  <% } %>

  <hr style="margin: 2rem 0;">

  <!-- Add Expense -->
  <h3>Add Expense</h3>

  <form action="/groups/<%= group.id %>/expenses/add" method="POST">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">

    <label>Description</label>
    <input type="text" name="description" required placeholder="e.g. Groceries, Taxi, Dinner">

    <label>Total Amount (€)</label>
    <input type="number" step="0.01" name="amount" required placeholder="0.00">

    <h4>Split Between Members</h4>

    <% members.forEach(m => { %>
      <div style="margin-bottom: 0.5rem;">
        <label><%= m.username %></label>
        <input 
          type="number"
          step="0.01"
          name="splits[<%= m.id %>]"
          value="0"
          required
        >
      </div>
    <% }) %>

    <button type="submit" style="margin-top: 1rem;">Add Expense</button>
  </form>

  <hr style="margin: 2rem 0;">

  <!-- Expenses List -->
  <h3>Expenses</h3>

  <% if (expenses.length === 0) { %>
    <p class="notice">No expenses added yet.</p>
  <% } else { %>
    <ul>
      <% expenses.forEach(e => { %>
        <li>
          <div class="expense-item">
            <span>
              <strong><%= e.description %></strong> — €<%= e.amount %>  
              (paid by <%= e.paidByName %>)
            </span>

            <span>
              <a href="/groups/<%= group.id %>/expenses/<%= e.id %>/edit">Edit</a>

              <form action="/groups/<%= group.id %>/expenses/<%= e.id %>/delete"
                    method="POST"
                    style="display:inline;">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <button class="small-btn" type="submit">Delete</button>
              </form>
            </span>
          </div>
        </li>
      <% }) %>
    </ul>
  <% } %>

  <hr style="margin: 2rem 0;">

  <!-- Balances -->
  <h3>Balances</h3>

  <ul>
    <% members.forEach(m => { 
         const bal = balances[m.id];
    %>
      <li>
        <strong><%= m.username %></strong>:
        <% if (bal > 0) { %>
          should receive €<%= bal.toFixed(2) %>
        <% } else if (bal < 0) { %>
          owes €<%= Math.abs(bal).toFixed(2) %>
        <% } else { %>
          is settled up
        <% } %>
      </li>
    <% }) %>
  </ul>

  <hr style="margin: 2rem 0;">

  <!-- Suggested Settlements -->
  <h3>Suggested Settlements</h3>

  <% if (settlements.length === 0) { %>
    <p class="notice">Everyone is settled up.</p>
  <% } else { %>
    <ul>
      <% settlements.forEach(s => { %>
        <li>
          <strong><%= userMap[s.fromUserId] %></strong>
          should pay
          <strong><%= userMap[s.toUserId] %></strong>
          €<%= s.amount.toFixed(2) %>
        </li>
      <% }) %>
    </ul>
  <% } %>

</div>

</body>
</html>
